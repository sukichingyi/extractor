<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Event & Lesson Lists</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f8fafc; }
    .tab-bar {
      display: flex; 
      border-bottom: 2px solid #ccc; 
      background: #f5f5f5;
      padding-left: 10px;
    }
    .tab {
      padding: 14px 24px;
      cursor: pointer;
      border: none;
      background: none;
      font-size: 1.15rem;
      color: #555;
      outline: none;
      border-bottom: 2px solid transparent;
      transition: background .2s, border-color .2s;
    }
    .tab.active {
      color: #0066cc;
      border-bottom: 2px solid #0066cc;
      background: #fff;
    }
    .page { display: none; padding: 20px; }
    .page.active { display: block; }
    /* Event Page: (original) */
    h2 { margin-top: 0; }
    textarea { width: 100%; height: 200px; padding: 10px; font-size: 1rem; margin-bottom: 10px; box-sizing: border-box; }
    button { padding: 6px 12px; font-size: 0.9rem; border: none; border-radius: 4px; background: #0066cc; color: #fff; cursor: pointer; margin: 4px; }
    button:hover { background: #004d99; }
    .danger { background: #cc0000 !important; }
    .calendar-btn { background: #28a745; }
    .calendar-btn:hover { background: #1e7e34; }
    .modify-btn { background: #ff9900; }
    .modify-btn:hover { background: #e68a00; }
     .pink-btn { background:pink;color:#333}
    .pink-btn:hover { background:#e055b4; }
    .list { margin-top: 20px; padding: 15px; background: #fff; border: 1px solid #ddd; border-radius: 6px; }
    .list-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-wrap: wrap; }
    .list h3 { margin: 0; font-size: 1rem; background: #444; color: #fff; padding: 5px 10px; border-radius: 4px; white-space:nowrap; }
    .header-buttons button { margin-left: 4px; }
    .event-wrapper { display:flex; gap:10px; }
    .event-content { flex:3; }
    .calc-panel { flex:1; padding:10px; border:1px dashed #888; background:#f0f8ff; border-radius:4px; }
    .calc-panel input { width:35px; padding:4px; margin:3px; }
    .calc-hidden { display:none; }
    .item { display: grid; grid-template-columns: auto 1fr auto auto auto; gap: 8px; margin: 8px 0; align-items: center; }
    .item-number { font-weight:bold; min-width: 20px; text-align:right; }
    .checkbox-label { display: flex; align-items: center; gap: 4px; font-size: 0.9rem; }
    .controls { display: contents; }
    .controls .group { display: flex; flex-wrap: wrap; gap: 6px; align-items:center; flex:1 1 100%; }
    .controls input[type="text"] { padding: 4px; border: 1px solid #ccc; border-radius: 4px; min-width: 100px; }
    .item-text { flex:1; padding:4px; border:1px solid #ccc; border-radius:4px; }
    .cat-å¿«æ¨‚ { color: green; font-weight: bold; }
    .cat-è¿‘åˆ { color: blue; font-weight: bold; }
    .cat-åˆ { color: orange; font-weight: bold; }
    .cat-åˆä¸­ { color: purple; font-weight: bold; }
    .categories-hidden { display: none !important; visibility: hidden !important; pointer-events: none !important; height: 0 !important; width: 0 !important; opacity: 0 !important; }
    .filter-box { margin:20px 0; padding:10px; background:#fff; border:1px solid #ccc; border-radius:6px; display:inline-block; }
    .filter-box select { padding:6px; border-radius:4px; border:1px solid #aaa; background:#f0f0f0; }
    .month-summary { margin-top: 10px; font-weight: bold; color:#333; background:#eef; padding:6px; border-radius:4px; }
    .header-å¿«æ¨‚ { background: #006400 !important; }
    /* Mobile responsive styles */
    @media (max-width: 800px) {
      .event-wrapper { flex-direction:column; }
      .calc-panel { width:100%; }
      .controls .group { flex-wrap:wrap; }
    }
    @media (max-width: 600px) {
      .categories-col {
        display: grid !important;
        grid-template-columns: 1fr 1fr;
        gap: 4px;
        width: 100%;
      }
      .categories-col label {
        margin: 2px 0;
        flex: 1;
        min-width: 80px;
      }
      .item {
        grid-template-columns: auto 1fr;
        gap: 6px;
      }
      .item-number { grid-column: 1; }
      .item-text { grid-column: 2; }
      .controls { grid-column: 1 / span 2; display: flex; flex-wrap: wrap; gap: 6px; }
      .checkbox-label { flex: 1; min-width: 80px; }
      .filter-box { display: flex; flex-direction: column; gap: 10px; }
      .filter-box label { display: flex; flex-direction: column; gap: 5px; }
      .header-buttons { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px; }
    }
    /* Lesson Page */
    #lesson-input-section { margin-bottom: 16px; }
    #lesson-input { width:100%; height:140px; font-size:1rem; padding:8px; box-sizing:border-box; }
    #lesson-btns { margin-bottom:10px; }
    .lesson-list { margin-top: 20px; }
    .lesson-card { background: #fff; border-radius: 6px; border: 1px solid #bde; padding: 16px 16px 6px 16px; margin-bottom: 20px; }
    .lesson-heading { font-size: 1.1rem; font-weight: bold; margin-bottom: 10px; color:#234; }
    .lesson-time, .lesson-court { color: #444; font-size: 1rem; margin-bottom: 6px; }
    .lesson-cost { font-size: 1.1rem; color: #0a881f; font-weight: bold; margin-bottom: 8px; }
    .lesson-btn-del { background:#cc0000; color:#fff; border:none; border-radius:4px; padding:4px 10px; font-size:0.95rem; cursor:pointer; }
    .lesson-btn-del:hover { background:#a00; }
    .lesson-month-summary { font-weight: bold; font-size: 1.08rem; background: #e7f6ee; color: #27734b; padding: 6px 12px; border-radius: 5px; margin-bottom: 14px;}
    @media (max-width:600px){
      .lesson-card { padding: 10px 6px 5px 10px; }
      .lesson-heading { font-size: 1rem; }
      .lesson-cost { font-size: 1rem; }
    }
  </style>
</head>
<body>
  <!-- Tab Bar -->
  <div class="tab-bar">
    <button class="tab active" onclick="showPage('event')">ğŸ¸ Event åå–®ç®¡ç†</button>
    <button class="tab" onclick="showPage('lesson')">ğŸ“š Lesson ç´€éŒ„</button>
  </div>
  
  <!-- Event Page -->
  <div class="page active" id="event-page">
    <h2>Add New Events</h2>
    <textarea id="inputText" placeholder="Paste events here..."></textarea><br>
    <button onclick="addList()">Add Event(s)</button>
    <button onclick="clearAll()">Clear All</button>
    <button class="pink-btn" onclick="toggleCategories()">Hide Categories</button>
    <button class="pink-btn"  onclick="toggleCalc()">Hide Calculation</button>
    <button onclick="exportJSON()">Export JSON</button>
    <button onclick="document.getElementById('importFile').click()">Import JSON</button>
    <button onclick="importJSONPrompt()">Import from Paste</button>
    <button onclick="copyJSON()">Copy JSON</button>
    <input id="importFile" type="file" accept="application/json" style="display:none" onchange="importJSONFile(event)">
    <div class="filter-box">
      <label>ğŸ” Search Name: 
        <input type="text" id="nameSearch" placeholder="Enter name..." oninput="renderLists()">
      </label>
      <label>ğŸ“… Filter Month: 
        <select id="monthFilter" onchange="renderLists()">
          <option value="">All</option>
        </select>
      </label>
      <label>ğŸ“ Filter Location: 
        <select id="locationFilter" onchange="renderLists()">
          <option value="">All</option>
        </select>
        <button onclick="deleteLocation()">âŒ Delete Selected</button>
      </label>
  
        <label>
        <input type="checkbox" id="yesterdayEventsOnly" onchange="renderLists()"> æ˜¨å¤©çš„å ´
      </label>
       <label>
        <input type="checkbox" id="todayEventsOnly" onchange="renderLists()"> ä»Šå¤©çš„å ´
      </label>
          <label>
        <input type="checkbox" id="futureEventsOnly" onchange="renderLists()"> å°‡ä¾†çš„å ´
      </label>
      <label>
        <input type="checkbox" id="happyEventsOnly" onchange="renderLists()"> å¿«æ¨‚å ´
      </label>
    </div>
    <div id="listsContainer"></div>
  </div>

  <!-- Lesson Page -->
  <div class="page" id="lesson-page">
    <h2>ğŸ“š Lesson ç´€éŒ„</h2>
    <div id="lesson-input-section">
      <textarea id="lesson-input" placeholder="æ¯æ¬¡ä¸€å€‹èª²å ‚ï¼Œæ¯è¡Œåˆ†éš”:
å·²bookå ´ç·´æ³¢
10/9
ç¾æ—é«”è‚²é¤¨
1400-1500
4è™Ÿå ´"></textarea><br>
      <div id="lesson-btns">
        <button onclick="addLessons()">Add Lesson(s)</button>
        <button onclick="clearAllLessons()">Clear All Lessons</button>
        <button onclick="exportLessons()">Export JSON</button>
        <button onclick="importLessonsPrompt()">Import from Paste</button>
        <button onclick="copyLessons()">Copy JSON</button>
        
      </div>
    </div>
    <div id="lesson-list"></div>
  </div>
  
<script>
/* -------- Tab Navigation -------- */
function showPage(page) {
  document.querySelectorAll('.tab').forEach(tab=>tab.classList.remove('active'));
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  if(page==='event'){
    document.querySelector('.tab:nth-child(1)').classList.add('active');
    document.getElementById('event-page').classList.add('active');
  }else{
    document.querySelector('.tab:nth-child(2)').classList.add('active');
    document.getElementById('lesson-page').classList.add('active');
    renderLessons();
  }
}

/* -------- Event Page -------- */
let savedLists = JSON.parse(localStorage.getItem("savedLists") || "[]");
let categoriesVisible = true;
let calcVisible = true;
let savedLocations = JSON.parse(localStorage.getItem("savedLocations") || "[]");
const categories = [
  { key: "å¿«æ¨‚", class: "cat-å¿«æ¨‚" },
  { key: "è¿‘åˆ", class: "cat-è¿‘åˆ" },
  { key: "åˆ", class: "cat-åˆ" },
  { key: "åˆä¸­", class: "cat-åˆä¸­" },
];
function renderLists() {
  const container = document.getElementById("listsContainer");
  container.innerHTML = "";
  populateMonthFilter();
  populateLocationFilter();
  const selectedMonth = document.getElementById("monthFilter").value;
  const selectedLoc = document.getElementById("locationFilter").value;
  const searchName = document.getElementById("nameSearch").value.toLowerCase();
  const happyOnly = document.getElementById("happyEventsOnly").checked;
  const futureOnly = document.getElementById("futureEventsOnly").checked;
  const yesterdayOnly = document.getElementById("yesterdayEventsOnly").checked;
  const todayOnly = document.getElementById("todayEventsOnly").checked;
  savedLists.sort((a,b)=>parseHeaderDate(a.header)-parseHeaderDate(b.header));
  let currentMonth=null;
  let monthTotal=0;
  savedLists.forEach((list, listIndex) => {
    const listMonth=(list.header.match(/(\d{1,2})æœˆ/)||[])[1];
    if (selectedMonth && listMonth!==selectedMonth) return;
    if (selectedLoc && !list.header.includes(selectedLoc)) return; 
    if (happyOnly && !list.header.includes("å¿«æ¨‚")) return;
    if (futureOnly && parseHeaderDate(list.header) < new Date()) return;
    // const now = new Date();
    if (yesterdayOnly && !isSameDay(parseHeaderDate(list.header),  new Date(new Date().setDate(new Date().getDate()-1)))) return;
    if (todayOnly && !isSameDay(parseHeaderDate(list.header),  new Date())) return;
    if (searchName) {
      const hasName = list.items.some(item => 
        item.text.toLowerCase().includes(searchName)
      );
      if (!hasName) return;
    }
    if(currentMonth && currentMonth!==listMonth){
      const summary=document.createElement("div");
      summary.className="month-summary";
      summary.textContent=`${currentMonth}æœˆ ç¸½æ·¨åˆ©: ğŸ’°${monthTotal}`;
      container.appendChild(summary);
      monthTotal=0;
    }
    currentMonth=listMonth;
    const listDiv = document.createElement("div");
    listDiv.className = "list";
    const headerDiv = document.createElement("div");
    headerDiv.className = "list-header";
    const header = document.createElement("h3");
    header.textContent = list.header;
    if (list.header.includes("å¿«æ¨‚")) header.classList.add("header-å¿«æ¨‚");
    const btns = document.createElement("div");
    btns.className = "header-buttons";
    const upBtn = document.createElement("button");
    upBtn.textContent = "â–²";
    upBtn.disabled = listIndex === 0;
    upBtn.onclick = () => moveEvent(listIndex, -1);
    const downBtn = document.createElement("button");
    downBtn.textContent = "â–¼";
    downBtn.disabled = listIndex === savedLists.length - 1;
    downBtn.onclick = () => moveEvent(listIndex, 1);
    const delBtn = document.createElement("button");
    delBtn.textContent = "Delete";
    delBtn.className = "danger";
    delBtn.onclick = () => {
      if (confirm("Delete this event?")) {
        savedLists.splice(listIndex, 1);
        save(); renderLists();
      }
    };
    const calBtn = document.createElement("button");
    calBtn.textContent = "Add to Calendar";
    calBtn.className = "calendar-btn";
    calBtn.onclick = () => addToGoogleCalendar(list.header, list.items);
    const addRowBtn = document.createElement("button");
    addRowBtn.textContent = "Add Row";
    addRowBtn.className = "add-row-btn";
    addRowBtn.onclick = () => {
      list.items.push({ text:"", payment:false, arrive:false, remark:"", categories:{} });
      save(); renderLists();
    };
    const modifyBtn = document.createElement("button");
    modifyBtn.textContent = "Modify";
    modifyBtn.className = "modify-btn";
    modifyBtn.onclick = () => {
      const newHeader = prompt("Edit event header:", list.header);
      if (newHeader !== null && newHeader.trim() !== "") {
        list.header = newHeader.trim();
        save();
        renderLists();
      }
    };
    btns.append(upBtn, downBtn, delBtn, calBtn, addRowBtn, modifyBtn);
    headerDiv.append(header, btns);
    listDiv.appendChild(headerDiv);
    const wrapper=document.createElement("div");
    wrapper.className="event-wrapper";
    const contentDiv=document.createElement("div");
    contentDiv.className="event-content";
    list.items.forEach((item, itemIndex) => {
      const div = document.createElement("div");
      div.className = "item";
      const numSpan=document.createElement("span");
      numSpan.className="item-number";
      numSpan.textContent=(itemIndex+1)+".";
      div.appendChild(numSpan);
      const textInput=document.createElement("input");
      textInput.type="text";
      textInput.className="item-text";
      textInput.value=item.text;
      textInput.placeholder="Name";
      textInput.oninput=()=>{ item.text=textInput.value; save(); };
      div.appendChild(textInput);
      const controls = document.createElement("div");
      controls.className = "controls";
      const arriveWrapper = document.createElement("label");
      arriveWrapper.className = "checkbox-label";
      const arriveBox = document.createElement("input");
      arriveBox.type = "checkbox";
      arriveBox.checked = item.arrive || false;
      arriveBox.onchange = () => { item.arrive = arriveBox.checked; save(); };
      arriveWrapper.append(arriveBox, document.createTextNode("Arrive"));
      controls.appendChild(arriveWrapper);
      const payWrapper = document.createElement("label");
      payWrapper.className = "checkbox-label";
      const payBox = document.createElement("input");
      payBox.type = "checkbox";
      payBox.checked = item.payment || false;
      payBox.onchange = () => { item.payment = payBox.checked; save(); };
      payWrapper.append(payBox, document.createTextNode("Payment"));
      controls.appendChild(payWrapper);
      if (!item.categories) item.categories = {};
      const groupDiv = document.createElement("div");
      groupDiv.className = "group categories-col";
      if (!categoriesVisible) groupDiv.classList.add("categories-hidden");
      else groupDiv.classList.remove("categories-hidden");
      categories.forEach(cat => {
        const wrap = document.createElement("label");
        wrap.style.display="flex"; 
        wrap.style.alignItems="center";
        wrap.style.flexWrap = "nowrap";
        const catBox = document.createElement("input");
        catBox.type="checkbox";
        catBox.checked=item.categories[cat.key]||false;
        catBox.onchange=()=>{ item.categories[cat.key]=catBox.checked; save(); };
        const span=document.createElement("span");
        span.textContent=cat.key; 
        if(cat.class) span.className=cat.class;
        wrap.append(catBox,span); 
        groupDiv.appendChild(wrap);
      });
      const remarkInput=document.createElement("input");
      remarkInput.type="text"; 
      remarkInput.placeholder="Remark";
      remarkInput.value=item.remark||"";
      remarkInput.oninput=()=>{ item.remark=remarkInput.value; save(); };
      remarkInput.className = "remark-input";
      if (!categoriesVisible) remarkInput.classList.add("categories-hidden");
      else remarkInput.classList.remove("categories-hidden");
      const removeBtn=document.createElement("button");
      removeBtn.textContent="âœ–";
      removeBtn.className="danger remove-btn";
      removeBtn.onclick=()=>{
        list.items.splice(itemIndex,1);
        save(); renderLists();
      };
      if (!categoriesVisible) removeBtn.classList.add("categories-hidden");
      else removeBtn.classList.remove("categories-hidden");
      groupDiv.appendChild(remarkInput);
      groupDiv.appendChild(removeBtn);
      controls.appendChild(groupDiv);
      div.appendChild(controls);
      contentDiv.appendChild(div);
    });
    const calcPanel=document.createElement("div");
    calcPanel.className="calc-panel";
    if(!calcVisible) calcPanel.classList.add("calc-hidden");
    const priceInput=document.createElement("input");
    priceInput.type="number"; priceInput.placeholder="Price";
    priceInput.value=list.price||extractPrice(list.header);
    priceInput.oninput=()=>{ list.price=parseInt(priceInput.value)||0; save(); renderLists(); };
    const personInput=document.createElement("input");
    personInput.type="number"; personInput.min="1"; personInput.value=list.persons||guessPersons(list.header);
    personInput.oninput=()=>{ list.persons=parseInt(personInput.value)||6; save(); renderLists(); };
    const hoursInput=document.createElement("input");
    hoursInput.type="number"; hoursInput.min="1"; hoursInput.value=list.hours||extractHours(list.header);
    hoursInput.oninput=()=>{ list.hours=parseInt(hoursInput.value)||1; save(); renderLists(); };
    const courtInput=document.createElement("input");
    courtInput.type="number"; courtInput.value=list.courtCost||calcCourt(list.header,hoursInput.value);
    courtInput.oninput=()=>{ list.courtCost=parseInt(courtInput.value)||0; save(); renderLists(); };
    const ballInput=document.createElement("input");
    ballInput.type="number"; ballInput.value=list.ballCost||25*(list.hours||1);
    ballInput.oninput=()=>{ list.ballCost=parseInt(ballInput.value)||0; save(); renderLists(); };
    const resultDiv=document.createElement("div");
    resultDiv.textContent="Result: -";
    const price=parseInt(priceInput.value)||0;
    const persons=parseInt(personInput.value)||6;
    const hours=parseInt(hoursInput.value)||1;
    const courtCost=parseInt(courtInput.value)||0;
    const ballCost=25*hours;
    ballInput.value=ballCost;
    const result=price*persons-courtCost-ballCost;
    resultDiv.textContent=`${price}Ã—${persons} - å ´åœ°:${courtCost} - çƒ:${ballCost} = ğŸ’°${result}`;
    list.net=result;
    monthTotal+=result;
    calcPanel.append("åƒ¹éŒ¢:",priceInput," äººæ•¸:",personInput," æ™‚æ•¸:",hoursInput," å ´åœ°:",courtInput," çƒ:",ballInput, resultDiv);
    wrapper.appendChild(contentDiv);
    wrapper.appendChild(calcPanel);
    listDiv.appendChild(wrapper);
    container.appendChild(listDiv);
  });
  if(currentMonth){
    const summary=document.createElement("div");
    summary.className="month-summary";
    summary.textContent=`${currentMonth}æœˆ ç¸½æ·¨åˆ©: ğŸ’°${monthTotal}`;
    container.appendChild(summary);
  }
}
function extractPrice(header){ const m=header.match(/\$ ?(\d+)/); return m?parseInt(m[1],10):0; }
function extractHours(header){
  const m=header.match(/(\d{1,2})(?:\s*[:ï¼š](\d{2}))?\s*-\s*(\d{1,2})(?:\s*[:ï¼š](\d{2}))?\s*(am|pm)?/i);
  if(!m) return 1;
  let start=parseInt(m[1]);
  let end=parseInt(m[3]);
  const ampm=m[5];
  if(ampm) {
    const isPM = ampm.toLowerCase() === 'pm';
    if(isPM) {
      if(start < 12) start += 12;
      if(end < 12) end += 12;
    } else {
      if(start === 12) start = 0;
      if(end === 12) end = 0;
    }
  }
  let dur=end-start;
  if(dur<=0) dur+=12;
  return dur;
}
function calcCourt(header,hours){ let per=59; if(/æœƒæ‰€/.test(header)){ const dow=new Date().getDay(); per=(dow===0||dow===6)?85:75; } else if(/é¡¥å¾‘|æ’å®‰/.test(header)) per=39; return per*(hours||1); }
function guessPersons(header){
  if(/Suki no/i.test(header)) return 7;
  if(/Suki/i.test(header)) return 6;
  return 6;
}
function parseHeaderDate(header){
  const m=header.match(/(\d{1,2})æœˆ(\d{1,2})æ—¥.*?(\d{1,2})(?::(\d{2}))?\s*-\s*(\d{1,2})(?::(\d{2}))?/);
  if(!m) return new Date(2099,11,31);
  const month=parseInt(m[1])-1;
  const day=parseInt(m[2]);
  let hour=parseInt(m[3]);
  const minute = m[4] ? parseInt(m[4]) : 0;
  if (hour < 12 && header.toLowerCase().includes('pm')) hour += 12;
  return new Date(new Date().getFullYear(), month, day, hour, minute);
}
function populateMonthFilter(){
  const sel=document.getElementById("monthFilter");
  const months=new Set();
  savedLists.forEach(list=>{
    const m=list.header.match(/(\d{1,2})æœˆ/);
    if(m) months.add(m[1]);
  });
  const currentVal=sel.value;
  sel.innerHTML='<option value="">All</option>';
  [...months].sort((a,b)=>a-b).forEach(m=>{
    const opt=document.createElement("option");
    opt.value=m; opt.textContent=m+"æœˆ";
    if(m===currentVal) opt.selected=true;
    sel.appendChild(opt);
  });
}
function populateLocationFilter(){
  const sel=document.getElementById("locationFilter");
  const locs=new Set(savedLocations);
  savedLists.forEach(list=>{
    const locMatch=list.header.match(/(æœƒæ‰€|é¡¥å¾‘|æ’å®‰|åœ“æ´²è§’|é¦¬å®‰å±±|é¦¬éå±±|è»Šå…¬å»Ÿ|ç¾æ—|æºç¦¾|é•·æ²™ç£|ä¿å®‰é“|åŒ—æ²³è¡—|å–®è»Šé¤¨)/);
    if(locMatch) locs.add(locMatch[1]);
  });
  savedLocations=[...locs];
  localStorage.setItem("savedLocations",JSON.stringify(savedLocations));
  const currentVal=sel.value;
  sel.innerHTML='<option value="">All</option>';
  savedLocations.forEach(l=>{
    const opt=document.createElement("option");
    opt.value=l; opt.textContent=l;
    if(l===currentVal) opt.selected=true;
    sel.appendChild(opt);
  });
}
function deleteLocation(){
  const sel=document.getElementById("locationFilter");
  const val=sel.value;
  if(!val) return;
  if(confirm("Delete location filter '"+val+"'?")){
    savedLocations=savedLocations.filter(l=>l!==val);
    localStorage.setItem("savedLocations",JSON.stringify(savedLocations));
    renderLists();
  }
}
function addList(){
  const input=document.getElementById("inputText").value.trim();
  if(!input) return;
  const blocks=input.split(/\n\s*\n/);
  blocks.forEach(block=>{
    const lines=block.split(/\r?\n/).map(l=>l.replace(/^â€¢\s*/,"")).filter(l=>l.trim()!=="");
    if(lines.length<2) return;
    let firstNumIndex=lines.findIndex(line=>/^\s*1[\.\s]/.test(line));
    if(firstNumIndex===-1) return;
    const header=lines.slice(0,firstNumIndex).join(" ").replace(/\s+/g," ").trim();
    const items=[];
    lines.slice(firstNumIndex).forEach(line=>{
      const match=line.match(/^\s*(\d+[\.\s]*)?(.+)$/);
      if(match) items.push({ text:match[2].trim(), payment:false, arrive:false, remark:"", categories:{} });
    });
    if(items.length>0) savedLists.push({ header, items });
  });
  save(); document.getElementById("inputText").value=""; renderLists();
}
function moveEvent(i,d){ const ni=i+d; if(ni<0||ni>=savedLists.length) return; const[m]=savedLists.splice(i,1); savedLists.splice(ni,0,m); save(); renderLists(); }
function clearAll(){ if(confirm("Clear all saved events?")){ savedLists=[]; localStorage.removeItem("savedLists"); renderLists(); } }
function save(){ localStorage.setItem("savedLists",JSON.stringify(savedLists)); }
function toggleCategories(){ categoriesVisible = !categoriesVisible; renderLists(); }
function toggleCalc(){ calcVisible=!calcVisible; renderLists(); }
function exportJSON(){ const dataStr=JSON.stringify(savedLists,null,2); const blob=new Blob([dataStr],{type:"application/json"}); const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download="events.json"; a.click(); URL.revokeObjectURL(url); }
function importJSONFile(e){ const file=e.target.files[0]; if(!file) return; const reader=new FileReader(); reader.onload=ev=>{ try{ const data=JSON.parse(ev.target.result); if(Array.isArray(data)){ savedLists=data; save(); renderLists(); alert("âœ… Imported!"); } else alert("âš ï¸ Invalid JSON"); } catch(err){ alert("âš ï¸ Error:"+err); } }; reader.readAsText(file); }
function importJSONPrompt(){ 
  const input=prompt("Paste JSON:"); 
  if(!input) return; 
  try{ 
    const data=JSON.parse(input); 
    if(Array.isArray(data)){ 
      savedLists = data;
      save(); 
      renderLists(); 
      alert("âœ… Imported!"); 
    } else {
      alert("âš ï¸ Invalid JSON: Expected an array"); 
    }
  } catch(err){ 
    alert("âš ï¸ Error:"+err); 
  } 
}
function copyJSON(){ const dataStr=JSON.stringify(savedLists,null,2); navigator.clipboard.writeText(dataStr).then(()=>alert("âœ… Copied!")).catch(err=>alert("âš ï¸ Failed:"+err)); }
function addToGoogleCalendar(headerText, items) {
  const dateMatch = headerText.match(/(\d{1,2})æœˆ(\d{1,2})æ—¥/);
  if (!dateMatch) {
    alert("ç„¡æ³•å¾æ¨™é¡Œè§£ææ—¥æœŸ");
    return;
  }
  const month = parseInt(dateMatch[1]);
  const day = parseInt(dateMatch[2]);
  const year = new Date().getFullYear();
  const timeMatch = headerText.match(/(\d{1,2})(?::(\d{2}))?\s*-\s*(\d{1,2})(?::(\d{2}))?\s*(ä¸Šåˆ|ä¸‹åˆ|am|pm)?/i);
  if (!timeMatch) {
    alert("ç„¡æ³•å¾æ¨™é¡Œè§£ææ™‚é–“");
    return;
  }
  let startHour = parseInt(timeMatch[1]);
  const startMinute = timeMatch[2] ? parseInt(timeMatch[2]) : 0;
  let endHour = parseInt(timeMatch[3]);
  const endMinute = timeMatch[4] ? parseInt(timeMatch[4]) : 0;
  const period = timeMatch[5] || '';
  if (period.toLowerCase().includes('ä¸‹åˆ') || period.toLowerCase() === 'pm') {
    if (startHour < 12) startHour += 12;
    if (endHour < 12) endHour += 12;
  } else if (period.toLowerCase().includes('ä¸Šåˆ') || period.toLowerCase() === 'am') {
    if (startHour === 12) startHour = 0;
    if (endHour === 12) endHour = 0;
  }
  const startDate = new Date(year, month - 1, day, startHour, startMinute);
  const endDate = new Date(year, month - 1, day, endHour, endMinute);
  const formatDate = (date) => {
    return date.toISOString().replace(/-|:|\.\d+/g, '');
  };
  let description = "åƒåŠ è€…:\n";
  items.forEach((item, index) => {
    description += `${index + 1}. ${item.text}\n`;
  });
  let title = headerText;
  title = title.replace(/\d{1,2}æœˆ\d{1,2}æ—¥.*?(am|pm)/i, "");
  title = title.replace(/\$\s*\d+/, "");
  title = title.replace(/é«”è‚²é¤¨/, "");
  title = title.replace(/ğŸˆµğŸˆµ/, "");
  title = title.replace(/ğŸˆ¶ğŸˆ¶/, "");
  title = title.trim();
  const baseUrl = "https://calendar.google.com/calendar/r/eventedit";
  const params = new URLSearchParams({
    text: title,
    dates: `${formatDate(startDate)}/${formatDate(endDate)}`,
    details: description,
    sf: true,
    output: 'xml'
  });

  window.open(`${baseUrl}?${params.toString()}`, '_blank');
}

function addToGoogleCalendarLesson(month,day, startHour,endHour, location) {
  const year = new Date().getFullYear(); 
  const startDate = new Date(year, month - 1, day, startHour, 0); 
  const endDate = new Date(year, month - 1, day, endHour, 0);
  const formatDate = (date) => {
    return date.toISOString().replace(/-|:|\.\d+/g, '');
  };
  console.log('after formatDate',)
  let title = location;
  // title = title.replace(/\d{1,2}æœˆ\d{1,2}æ—¥.*?(am|pm)/i, "");
  // title = title.replace(/\$\s*\d+/, "");
  title = title.replace(/é«”è‚²é¤¨/, "");
  // title = title.replace(/ğŸˆµğŸˆµ/, "");
  // title = title.replace(/ğŸˆ¶ğŸˆ¶/, "");
  // title = title.trim();
  console.log('???? ',`${formatDate(startDate)}/${formatDate(endDate)}`)
  const baseUrl = "https://calendar.google.com/calendar/r/eventedit";
  const params = new URLSearchParams({
    text: title,
    dates: `${formatDate(startDate)}/${formatDate(endDate)}`,
    details: '',
    sf: true,
    output: 'xml'
  });

  window.open(`${baseUrl}?${params.toString()}`, '_blank');
}
window.addEventListener("load", renderLists);

/* -------- Lesson Page -------- */
let lessonData = JSON.parse(localStorage.getItem("lessonData") || "[]");

// Add this function to save lesson data
function saveLessons() {
  localStorage.setItem("lessonData", JSON.stringify(lessonData));
}

function addLessons() {
  const input = document.getElementById("lesson-input").value.trim();
  if (!input) return;
  
  const {day, month, startHour, startMinute, endHour, endMinute, eventName, court} = parseExtraText(input);

  lessonData.push({
    month: month,
    day: day, 
    location: eventName, 
    startHour: startHour, 
    startMinute: startMinute, 
    endHour: endHour, 
    endMinute: endMinute, 
    court: court, 
    cost: 260,
    hours: ((endHour*60+endMinute) - (startHour*60+startMinute)) / 60,
    rate: 260
  });
  
  saveLessons();
  document.getElementById("lesson-input").value = "";
  renderLessons();
}

function renderLessons() {
  const container = document.getElementById("lesson-list");
  container.innerHTML = "";
  if (!lessonData.length) {
    container.innerHTML = '<div style="color:#888">æ²’æœ‰èª²å ‚è¨˜éŒ„</div>';
    return;
  }
  
  // Sort by date
  lessonData.sort((a, b) => {
    if (a.month !== b.month) return a.month - b.month;
    if (a.day !== b.day) return a.day - b.day;
    if (a.startHour !== b.startHour) return a.startHour - b.startHour;
    return a.startMinute - b.startMinute;
  });
  
  let currentMonth = null;
  let monthTotal = 0;
  
  lessonData.forEach((lesson, idx) => {
    if (currentMonth && currentMonth !== lesson.month) {
      // Show summary for last month
      const sumDiv = document.createElement("div");
      sumDiv.className = "lesson-month-summary";
      sumDiv.textContent = `${currentMonth}æœˆåˆå…±ï¼š$${monthTotal}`;
      container.appendChild(sumDiv);
      monthTotal = 0;
    }
    
    currentMonth = lesson.month;
    
    // Calculate hours if not set
    if (!lesson.hours) {
      lesson.hours = ((lesson.endHour*60+lesson.endMinute) - (lesson.startHour*60+lesson.startMinute)) / 60;
    }
    
    // Calculate cost if not set
    if (!lesson.cost) {
      lesson.cost = lesson.hours * (lesson.rate || 260);
    }
    
    // Update month total
    monthTotal += lesson.cost;
    
    const card = document.createElement("div");
    card.className = "lesson-card";
    card.style.display = "flex";
    card.style.gap = "12px";

    // Left side - basic info
    const left = document.createElement("div");
    left.style.flex = "3";
    
    const heading = document.createElement("div");
    heading.className = "lesson-heading";
    heading.textContent = `${lesson.month}æœˆ${lesson.day}æ—¥ ${lesson.location}`;
    left.appendChild(heading);
    
    const time = document.createElement("div");
    time.className = "lesson-time";
    time.textContent = `${pad(lesson.startHour)}:${pad(lesson.startMinute)} ~ ${pad(lesson.endHour)}:${pad(lesson.endMinute)}`;
    left.appendChild(time);
    
    // const cost = document.createElement("div");
    // cost.className = "lesson-cost";
    // cost.textContent = `è²»ç”¨: $${lesson.cost}`;
    // left.appendChild(cost);
    
    // Calendar button
    const calBtn = document.createElement("button");
    calBtn.textContent = "Add to Calendar";
    calBtn.className = "calendar-btn";
    calBtn.onclick = () => addToGoogleCalendarLesson(lesson.month, lesson.day, lesson.startHour, lesson.endHour, lesson.location);
    left.appendChild(calBtn);
    
    // Delete button
    const delBtn = document.createElement("button");
    delBtn.className = "lesson-btn-del";
    delBtn.textContent = "âœ– åˆªé™¤";
    delBtn.onclick = () => {
      if (confirm("Delete this lesson?")) {
        lessonData.splice(idx, 1);
        saveLessons();
        renderLessons();
      }
    };
    left.appendChild(delBtn);
    
    card.appendChild(left);

    // Right side - calculation panel
    const right = document.createElement("div");
    right.style.flex = "1";
    right.style.borderLeft = "1px dashed #aaa";
    right.style.paddingLeft = "8px";
    
    // Hours input
    const hoursLabel = document.createElement("label");
    hoursLabel.textContent = "å°æ™‚:";
    hoursLabel.style.display = "block";
    hoursLabel.style.marginBottom = "5px";
    
    const hoursInput = document.createElement("input");
    hoursInput.type = "number";
    hoursInput.min = "1";
    hoursInput.step = "0.5";
    hoursInput.value = lesson.hours;
    hoursInput.style.width = "60px";
    hoursInput.style.marginBottom = "10px";
    hoursInput.oninput = () => {
      lesson.hours = parseFloat(hoursInput.value) || 1;
      lesson.cost = lesson.hours * (lesson.rate || 260);
      saveLessons();
      renderLessons(); // Re-render to update the display
    };
    
    hoursLabel.appendChild(hoursInput);
    right.appendChild(hoursLabel);
    
    // Rate input
    const rateLabel = document.createElement("label");
    rateLabel.textContent = "å–®åƒ¹:";
    rateLabel.style.display = "block";
    rateLabel.style.marginBottom = "5px";
    
    const rateInput = document.createElement("input");
    rateInput.type = "number";
    rateInput.min = "1";
    rateInput.value = lesson.rate || 260;
    rateInput.style.width = "60px";
    rateInput.style.marginBottom = "10px";
    rateInput.oninput = () => {
      lesson.rate = parseInt(rateInput.value) || 260;
      lesson.cost = lesson.hours * lesson.rate;
      saveLessons();
      renderLessons(); // Re-render to update the display
    };
    
    rateLabel.appendChild(rateInput);
    right.appendChild(rateLabel);
    
    // Cost display
    const costDisplay = document.createElement("div");
    costDisplay.textContent = `ç¸½è¨ˆ: $${lesson.cost}`;
    costDisplay.style.fontWeight = "bold";
    costDisplay.style.marginTop = "10px";
    right.appendChild(costDisplay);
    
    card.appendChild(right);
    container.appendChild(card);
  });
  
  // Last month summary
  if (currentMonth) {
    const sumDiv = document.createElement("div");
    sumDiv.className = "lesson-month-summary";
    sumDiv.textContent = `${currentMonth}æœˆåˆå…±ï¼š$${monthTotal}`;
    container.appendChild(sumDiv);
  }
}

function pad(n) { return n < 10 ? "0"+n : n; }

function clearAllLessons(){
  if(confirm("ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰èª²å ‚ç´€éŒ„ï¼Ÿ")){
    lessonData = [];
    localStorage.removeItem("lessonData");
    renderLessons();
  }
}

function exportLessons(){
  const dataStr=JSON.stringify(lessonData,null,2); 
  const blob=new Blob([dataStr],{type:"application/json"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a"); 
  a.href=url; a.download="lessons.json"; a.click(); 
  URL.revokeObjectURL(url);
}

function copyLessons(){
  const dataStr=JSON.stringify(lessonData,null,2);
  navigator.clipboard.writeText(dataStr)
    .then(()=>alert("âœ… Copied!"))
    .catch(err=>alert("âš ï¸ Failed:"+err));
}

function importLessonsPrompt(){
  const input=prompt("Paste JSON:");
  if(!input) return;
  try{
    const data=JSON.parse(input);
    if(Array.isArray(data)){
      lessonData = data;
      saveLessons();
      renderLessons();
      alert("âœ… Imported!");
    } else {
      alert("âš ï¸ Invalid JSON: Expected an array");
    }
  }catch(err){
    alert("âš ï¸ Error:"+err);
  }
}

function isSameDay(d1, d2) {
  return d1.getFullYear() === d2.getFullYear() &&
         d1.getMonth() === d2.getMonth() &&
         d1.getDate() === d2.getDate();
}

function parseExtraText(text) {
  const lines = text.split('\n').map(l => l.trim()).filter(Boolean);

  if (lines.length < 4) {
    console.log('è¡Œæ•¸ä¸è¶³');
    return {};
  }

  const dateMatch = lines[1].match(/(\d{1,2})\/(\d{1,2})/);
  if (!dateMatch) {
    console.log('æ‰¾ä¸åˆ°æ—¥æœŸ');
    return {};
  }

  const day = Number(dateMatch[1]);
  const month = Number(dateMatch[2]);

  const timeMatch = lines[3].match(/(\d{2})(\d{2})-(\d{2})(\d{2})/);
  if (!timeMatch) {
    console.log('æ‰¾ä¸åˆ°æ™‚é–“ç¯„åœ');
    return {};
  }

  const startHour = Number(timeMatch[1]);
  const startMinute = Number(timeMatch[2]);
  const endHour = Number(timeMatch[3]);
  const endMinute = Number(timeMatch[4]);

  const venue = lines[2];
  const court = lines.length >= 5 ? lines[4] : '';
  
  const eventName = `${venue}${court}ä¸Šå ‚`;
  
  return {
    month,
    day,
    startHour,
    startMinute,
    endHour,
    endMinute,
    eventName,
    court,
  };
}
</script>
</body>
</html>